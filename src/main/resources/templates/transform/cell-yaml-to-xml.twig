{%- if yaml.isObject -%}
	{#- ___________ yaml is object _________ -#}

	{%- if cellmodels.size()>1 -%}
		{#- We try to find a matching cell model -#}
	
		{%- for c in cellmodels -%}
			{%- if c.metadata.getDirectivesFor(case).contains('ATTRIBUTES-ONLY') -%}
				{#- match by attributes or children -#}
				{%- for a in c.asComplex.attributes.asList -%} 
				{%- if yaml.has(a.name) -%}
					{%- set found = true -%}
					{%- include 'cell-yaml-to-xml.twig' with {'yaml': yaml, 'cellmodels':[c], 'i':i, 'case': case} only -%}
				{%- endif -%}
				{%- endfor -%}
				{%- if not found -%}
					{%- for child in cm.asComplex.children.asList -%}
						{%- if child.metadata.getDirectivesFor(case).contains('LISTS-NO-PLURAL') -%}
							{%- set matchname = child.name -%}
						{%- else -%}
							{%- set matchname = concat(child.name, 's') -%}
						{%- endif -%}
						{%- if yaml.has(matchname) -%}
							{#- Matched a field in the yaml and an attribute, we assume we have a match -#}
							{%- set found = true -%}
							{%- include 'cell-yaml-to-xml.dtwig' with {'yaml': yaml.get(matchname), 'cellmodels':[child], 'i':i, 'case': case} only -%}
						{%- endif -%}
					{%- endfor -%}
				{% endif %}
			{%- else -%}
				{#- match by name -#}
				MATCH BY NAME
			{% endif -%}
		{%- endfor -%}
	
	{%- else -%}
		{#- cellmodels.size()==1 - We are already matched to a cell model, we start printing -#}
		{%- if cellmodels[0].isSimple -%}
			{%- if yaml.size>0 %}
{{i}}<{{cellmodels[0].name}}>{{yaml.asText}}</{{cellmodels[0].name}}>
			{%- else %}
{{i}}<{{cellmodels[0].name}}/>
				{%- endif -%}
{% else %}	{#- complex #}
{{i}}<{{cellmodels[0].name}}
			{%- for a in list(cellmodels[0].metadata.getAttributesFor(case).iterator) %} {{a-}}{%- endfor -%}
			{#- we check if we have key-value attributes or normal ones, in the case of k:v, we skip verification of the key -#}
			{%- if cellmodels[0].metadata.getDirectivesFor(case).contains('KEY-VALUE') %} {{cellmodels[0].metadata.identifier.get}}={{quote(yaml.fieldNames().next()) -}}
				{%- for a in cellmodels[0].asComplex.attributes.asList %}{% if a.getName()!=(cellmodels[0].metadata.identifier.get()) %} {{a.name}}={{quote(yaml.get(yaml.fieldNames().next()))}}{% endif %}{%- endfor -%}
			{%- else -%}
				{%- for a in cellmodels[0].asComplex.attributes.asList %} {%- if yaml.has(a.name)%} {{a.name}}={{quote(yaml.get(a.name))}}{% endif %}{%- endfor -%}
			{%- endif -%}
			{%- if cellmodels[0].asComplex.children.size()>0 -%}
				>{% for y in list(yaml.fieldNames) -%} {#- THIS LOOKS LIKE THE CODE ABOVE FOR ONE CELL, WE CAN DO AN INCLUDE OF GIVEN ONE CM + FIELD NAMES, WE MATCH -#} 
					{%- for child in cellmodels[0].asComplex.children.asList -%}
						{%- if child.metadata.getDirectivesFor(case).contains('LISTS-NO-PLURAL') -%}
							{%- set matchname = child.name -%}
						{%- else -%}
							{%- set matchname = concat(child.name, 's') -%}
						{%- endif -%}
						{%- if y==matchname -%}
							{#- Matched a field in the yaml and a child in the model, we have a match -#}
							{%- set found = true -%}
							{%- include 'cell-yaml-to-xml.dtwig' with {'yaml': yaml.get(matchname), 'cellmodels':[child], 'i':i, 'case': case} only -%}
						{%- endif -%}
					{%- endfor -%}
				{%- endfor %}
{{i}}</{{cellmodels[0].name}}>
			{%- else -%}
				/>
			{%- endif %}
		{%- endif -%}

	{%- endif -%} {#- size -#}

{%- elseif yaml.isTextual -%}
	{#- ___________ yaml is a simple text node _________ -#}
{{i}}<{{cellmodels[0].name}}>{{yaml.asText}}</{{cellmodels[0].name}}>
{% elseif yaml.isArray -%}
	{#- ___________ yaml is array _________ -#}
	{%- for y in range(yaml.size()) -%}
{% include 'cell-yaml-to-xml.dtwig' with {'yaml': yaml.get(y), 'cellmodels':cellmodels, 'i':concat(i,'\t'), 'case': case} only -%}
	{%- endfor -%}

{%- endif -%}
